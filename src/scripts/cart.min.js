document.addEventListener('DOMContentLoaded',()=>{const CART_KEY='kas_cart';const cartBadges=document.querySelectorAll('.cart-badge');const addToCartBtns=document.querySelectorAll('.add-to-cart-btn,.add-cart-btn');const cartIconBtn=document.querySelector('.nav-icon-btn-v2[aria-label="Cart"]');let cart=JSON.parse(localStorage.getItem(CART_KEY))||[];updateCartBadges();createCartDrawer();addToCartBtns.forEach(btn=>{btn.addEventListener('click',(e)=>{e.preventDefault();const card=btn.closest('.product-card')|| btn.closest('.deal-card');if(card){const title=card.querySelector('.product-title,.deal-title')?.innerText || 'Unknown Item';const priceText=card.querySelector('.product-price,.current-price')?.innerText || '0';const imgSrc=card.querySelector('img')?.src || '';const price=parseInt(priceText.replace(/[^0-9]/g,''))|| 0;addItemToCart({id:Date.now(),title,price,image:imgSrc,quantity:1});}});});if(cartIconBtn){cartIconBtn.addEventListener('click',(e)=>{e.preventDefault();toggleCartDrawer();});}function addItemToCart(item){const existing=cart.find(i=> i.title===item.title);if(existing){existing.quantity++;}else{cart.push(item);}saveCart();updateCartBadges();updateCartDrawer();showToast(`Added to cart:${item.title}`);const btn=document.activeElement;if(btn &&(btn.classList.contains('add-to-cart-btn')|| btn.classList.contains('add-cart-btn'))){const originalHTML=btn.innerHTML;btn.innerHTML='<i class="fas fa-check"></i> Added';btn.classList.add('added');setTimeout(()=>{btn.innerHTML=originalHTML;btn.classList.remove('added');},2000);}}function saveCart(){localStorage.setItem(CART_KEY,JSON.stringify(cart));}function updateCartBadges(){const count=cart.reduce((total,item)=> total+item.quantity,0);cartBadges.forEach(badge=>{badge.innerText=count;badge.style.display=count > 0 ? 'flex':'none';badge.style.transform='scale(1.2)';setTimeout(()=> badge.style.transform='scale(1)',200);});}function createCartDrawer(){const drawer=document.createElement('div');drawer.id='cartDrawer';drawer.className='cart-drawer';drawer.innerHTML=` <div class="cart-drawer-overlay"></div> <div class="cart-drawer-content"> <div class="cart-header"> <h3>Your Basket</h3> <button class="close-cart"><i class="fas fa-times"></i></button> </div> <div class="cart-items-list"> <!--Items will be injected here--> </div> <div class="cart-footer"> <div class="cart-total"> <span>Total:</span> <span class="total-amount">KSh 0</span> </div> <button class="whatsapp-checkout-btn"> <i class="fab fa-whatsapp"></i> Checkout via WhatsApp </button> </div> </div> `;document.body.appendChild(drawer);const modal=document.createElement('div');modal.id='checkoutModal';modal.className='checkout-modal';modal.innerHTML=` <div class="checkout-modal-content"> <div class="checkout-header"> <h3>Complete Your Order</h3> <button class="close-modal"><i class="fas fa-times"></i></button> </div> <div class="checkout-body"> <div class="form-group"> <label>Name</label> <input type="text" id="customerName" placeholder="Your Name" required> </div> <div class="form-group"> <label>Delivery Location</label> <textarea id="customerLocation" placeholder="e.g. Nairobi,Westlands,Delta Towers" rows="2" required></textarea> </div> </div> <div class="checkout-footer"> <button class="btn-confirm-order"><i class="fab fa-whatsapp"></i> Send Order</button> </div> </div> `;document.body.appendChild(modal);const style=document.createElement('style');style.textContent=` .checkout-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px);z-index:20000;display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:opacity 0.3s ease;}.checkout-modal.active{opacity:1;pointer-events:all;}.checkout-modal-content{background:#1a1a1a;width:90%;max-width:400px;border:1px solid rgba(255,255,255,0.1);border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,0.5);transform:translateY(20px);transition:transform 0.3s ease;color:white;}.checkout-modal.active .checkout-modal-content{transform:translateY(0);}.checkout-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;}.checkout-body{padding:20px;}.form-group{margin-bottom:15px;}.form-group label{display:block;margin-bottom:8px;font-size:0.9rem;color:#ccc;}.form-group input,.form-group textarea{width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:white;font-family:inherit;}.checkout-footer{padding:20px;border-top:1px solid rgba(255,255,255,0.05);}.btn-confirm-order{width:100%;padding:14px;background:#25D366;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;justify-content:center;gap:10px;}.btn-confirm-order:hover{background:#128C7E;}.close-modal{background:none;border:none;color:white;cursor:pointer;font-size:1.1rem;}`;document.head.appendChild(style);drawer.querySelector('.close-cart').onclick=toggleCartDrawer;drawer.querySelector('.cart-drawer-overlay').onclick=toggleCartDrawer;drawer.querySelector('.whatsapp-checkout-btn').onclick=openCheckoutModal;modal.querySelector('.close-modal').onclick=closeCheckoutModal;modal.querySelector('.btn-confirm-order').onclick=finalizeCheckout;modal.addEventListener('click',(e)=>{if(e.target===modal)closeCheckoutModal();});updateCartDrawer();}function toggleCartDrawer(){const drawer=document.getElementById('cartDrawer');drawer.classList.toggle('active');document.body.style.overflow=drawer.classList.contains('active')? 'hidden':'';}function updateCartDrawer(){const list=document.querySelector('.cart-items-list');const totalEl=document.querySelector('.total-amount');if(!list || !totalEl)return;if(cart.length===0){list.innerHTML='<div class="empty-cart-msg">Your basket is empty</div>';totalEl.innerText='KSh 0';return;}let total=0;list.innerHTML=cart.map((item,index)=>{total+=item.price*item.quantity;return ` <div class="cart-item"> <img src="${item.image}" alt="${item.title}" class="cart-item-img"> <div class="cart-item-info"> <div class="cart-item-title">${item.title}</div> <div class="cart-item-price">${item.quantity}x KSh ${item.price.toLocaleString()}</div> <button class="cart-item-remove" data-index="${index}">Remove</button> </div> </div> `;}).join('');totalEl.innerText=`KSh ${total.toLocaleString()}`;document.querySelectorAll('.cart-item-remove').forEach(btn=>{btn.onclick=(e)=>{const index=e.target.getAttribute('data-index');removeItem(index);};});}function removeItem(index){cart.splice(index,1);saveCart();updateCartBadges();updateCartDrawer();}window.updateItemQty=function(index,change){const item=cart[index];if(!item)return;item.quantity+=change;if(item.quantity <=0){removeItem(index);return;}saveCart();updateCartBadges();updateCartDrawer();};function openCheckoutModal(){if(cart.length===0){showToast('Your basket is empty');return;}document.getElementById('checkoutModal').classList.add('active');toggleCartDrawer();}function closeCheckoutModal(){document.getElementById('checkoutModal').classList.remove('active');}function finalizeCheckout(){const name=document.getElementById('customerName').value.trim();const location=document.getElementById('customerLocation').value.trim();if(!name || !location){showToast('Please fill in all details');return;}const businessNumber="254712345678";let message=`*NEW ORDER-GRACEFUL MOTION*\n`;message+=`------------------\n`;message+=`*Customer:*${name}\n`;message+=`*Location:*${location}\n\n`;message+=`*ORDER DETAILS:*\n`;let total=0;cart.forEach((item,i)=>{const itemTotal=item.price*item.quantity;total+=itemTotal;message+=`${i+1}. ${item.title}\n`;message+=` Qty:${item.quantity}| Total:KSh ${itemTotal.toLocaleString()}\n\n`;});message+=`------------------\n`;message+=`*GRAND TOTAL:KSh ${total.toLocaleString()}*\n`;message+=`------------------\n`;message+=`Please confirm availability and delivery cost. Thank you!`;const encodedMessage=encodeURIComponent(message);const whatsappUrl=`https:window.open(whatsappUrl,'_blank');closeCheckoutModal();}function showToast(message){let container=document.querySelector('.toast-container');if(!container){container=document.createElement('div');container.className='toast-container';document.body.appendChild(container);const style=document.createElement('style');style.textContent=` .toast-container{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;}.toast{background:#333;color:white;padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:flex;align-items:center;gap:10px;animation:slideIn 0.3s ease-out forwards;min-width:250px;}.toast.success{background:#10B981;}.toast i{font-size:1.1rem;}@keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}@keyframes fadeOut{to{opacity:0;transform:translateY(10px);}}`;document.head.appendChild(style);}const toast=document.createElement('div');toast.className='toast success';toast.innerHTML=`<i class="fas fa-check-circle"></i> <span>${message}</span>`;container.appendChild(toast);setTimeout(()=>{toast.style.animation='fadeOut 0.5s ease-out forwards';setTimeout(()=> toast.remove(),500);},3000);}});