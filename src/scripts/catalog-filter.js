/**
 * Catalog Filter Logic - Renovyte V2
 * Dynamically renders products from RenovyteProducts database
 */

document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const makeSelect = document.getElementById('filterMake');
    const modelSelect = document.getElementById('filterModel');
    const yearSelect = document.getElementById('filterYear');
    const engineSelect = document.getElementById('filterEngine');
    const categorySelect = document.getElementById('filterCategory');
    const findPartsBtn = document.getElementById('findPartsBtn');
    const resetBtn = document.getElementById('resetFiltersBtn');
    const productGrid = document.getElementById('productGrid');

    // Vehicle Data
    const carData = {
        'Toyota': { models: ['Corolla', 'Camry', 'Vitz', 'Land Cruiser', 'Hilux'], years: ['2024', '2023', '2022', '2021', '2020'] },
        'Nissan': { models: ['X-Trail', 'Navara', 'Note', 'Juke', 'March'], years: ['2023', '2022', '2021', '2020', '2019'] },
        'Subaru': { models: ['Forester', 'Impreza', 'Outback', 'Legacy', 'XV'], years: ['2023', '2022', '2021', '2020'] }
        // ... extend as needed
    };

    const engineSizes = ['1000cc', '1500cc', '2000cc', '2500cc', '3000cc+', 'Diesel', 'Hybrid'];

    // Initial Render
    renderProducts(window.RenovyteProducts || []);
    initMakeDropdown();

    // Check URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const categoryParam = urlParams.get('category');
    const searchParam = urlParams.get('search');
    const subcategoryParam = urlParams.get('item'); // Mapped from 'item' in menu

    if (categoryParam) {
        categorySelect.value = categoryParam;
    }

    // Apply initial filters (category + search)
    applyFilters(searchParam);

    // --- Core Functions ---

    function renderProducts(products) {
        if (!productGrid) return;

        productGrid.innerHTML = '';

        if (products.length === 0) {
            productGrid.innerHTML = `
                <div class="no-results-state" style="grid-column: 1/-1; text-align: center; padding: 60px 0; opacity: 0.5;">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>Zero Results Found</h3>
                    <p>Try adjusting your filters or search terms.</p>
                </div>
            `;
            return;
        }

        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="product-image-wrapper">
                    <img src="${product.image}" alt="${product.name}" class="product-image" onerror="this.src='assets/images/hero/hero-1.webp'">
                </div>
                <div class="product-details">
                    <p class="product-category">${product.category}</p>
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-price-row">
                        <span class="product-price">${product.price}</span>
                        <a href="product-details.html?id=${product.id}" class="view-detail-btn">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            `;
            productGrid.appendChild(card);
        });
    }

    function applyFilters(searchQuery = '') {
        const filters = {
            category: categorySelect.value,
            make: makeSelect.value,
            model: modelSelect.value
        };

        // If called from button click, update search query from input if exists
        // (For now, we just rely on the passed searchQuery or the form inputs if we had a search input on page)

        const filtered = (window.RenovyteProducts || []).filter(p => {
            const matchCategory = !filters.category || p.category === filters.category;
            const matchMake = !filters.make || p.make === 'Universal' || p.make === filters.make;
            const matchModel = !filters.model || p.model === 'Universal' || p.model === filters.model;

            let matchSearch = true;
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                matchSearch = p.name.toLowerCase().includes(q) ||
                    p.description.toLowerCase().includes(q) ||
                    p.subcategory?.toLowerCase().includes(q) ||
                    p.id.toLowerCase().includes(q);
            }

            // Subcategory filter (exact match if passed via URL)
            const matchSubcategory = !subcategoryParam || (p.subcategory && p.subcategory === subcategoryParam);

            return matchCategory && matchMake && matchModel && matchSearch && matchSubcategory;
        });

        renderProducts(filtered);
    }

    // --- Dropdown Management ---

    function initMakeDropdown() {
        if (!makeSelect) return;
        const makes = Object.keys(carData).sort();
        populateDropdown(makeSelect, makes);
    }

    makeSelect?.addEventListener('change', (e) => {
        const make = e.target.value;
        resetSelect(modelSelect, 'Select Model');
        if (make && carData[make]) {
            populateDropdown(modelSelect, carData[make].models);
            modelSelect.disabled = false;
        } else {
            modelSelect.disabled = true;
        }
    });

    findPartsBtn?.addEventListener('click', applyFilters);

    resetBtn?.addEventListener('click', () => {
        categorySelect.value = '';
        makeSelect.value = '';
        resetSelect(modelSelect, 'Select Model');
        modelSelect.disabled = true;
        renderProducts(window.RenovyteProducts || []);
    });

    // Helper functions
    function populateDropdown(select, items) {
        items.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            select.appendChild(opt);
        });
    }

    function resetSelect(select, text) {
        select.innerHTML = `<option value="">${text}</option>`;
    }
});
