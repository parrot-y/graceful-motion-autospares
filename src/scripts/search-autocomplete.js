/**
 * Search Autocomplete Logic
 * Provides real-time suggestions for the search inputs.
 */

document.addEventListener('DOMContentLoaded', () => {
    const searchInputs = document.querySelectorAll('.search-input-v2, .search-part-input');

    // Create autocomplete container if it doesn't exist (for header)
    // The header already has a form. We'll append the results container to the form or wrapper.

    searchInputs.forEach(input => {
        // Wrapper for positioning
        const wrapper = input.parentElement; // Usually the form
        if (!wrapper.style.position) wrapper.style.position = 'relative';

        const resultsContainer = document.createElement('div');
        resultsContainer.className = 'search-autocomplete-results';
        resultsContainer.style.display = 'none';
        wrapper.appendChild(resultsContainer);

        input.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();

            if (query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            if (!window.RenovyteProducts) return;

            const matches = window.RenovyteProducts.filter(p =>
                p.name.toLowerCase().includes(query) ||
                p.subcategory?.toLowerCase().includes(query) ||
                p.category.toLowerCase().includes(query)
            ).slice(0, 5); // Limit to 5 results

            if (matches.length > 0) {
                renderResults(matches, resultsContainer);
            } else {
                resultsContainer.style.display = 'none';
            }
        });

        // Hide on click outside
        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });
    });

    function renderResults(products, container) {
        container.innerHTML = `
            <ul class="autocomplete-list">
                ${products.map(p => `
                    <li>
                        <a href="product-details.html?id=${p.id}" class="autocomplete-item">
                            <img src="${p.image}" alt="${p.name}" class="autocomplete-thumb" onerror="this.src='assets/images/hero/hero-1.webp'">
                            <div class="autocomplete-info">
                                <span class="autocomplete-title">${p.name}</span>
                                <span class="autocomplete-meta">${p.subcategory || p.category}</span>
                            </div>
                            <span class="autocomplete-price">${p.price}</span>
                        </a>
                    </li>
                `).join('')}
                <li class="autocomplete-footer">
                    <button type="submit" class="view-all-results">View all results</button>
                </li>
            </ul>
        `;

        // Add basic styles dynamically if not present
        if (!document.getElementById('autocomplete-styles')) {
            const style = document.createElement('style');
            style.id = 'autocomplete-styles';
            style.textContent = `
                .search-autocomplete-results {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    width: 100%;
                    background: #1a1a1a;
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 0 0 8px 8px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                    z-index: 1000;
                    margin-top: 5px;
                }
                .autocomplete-list {
                    list-style: none;
                    margin: 0;
                    padding: 0;
                }
                .autocomplete-item {
                    display: flex;
                    align-items: center;
                    padding: 10px;
                    text-decoration: none;
                    color: white;
                    border-bottom: 1px solid rgba(255,255,255,0.05);
                    transition: background 0.2s;
                }
                .autocomplete-item:hover {
                    background: rgba(255,255,255,0.05);
                }
                .autocomplete-thumb {
                    width: 40px;
                    height: 40px;
                    object-fit: cover;
                    border-radius: 4px;
                    margin-right: 12px;
                }
                .autocomplete-info {
                    flex: 1;
                    min-width: 0;
                }
                .autocomplete-title {
                    display: block;
                    font-size: 0.9rem;
                    font-weight: 500;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                .autocomplete-meta {
                    display: block;
                    font-size: 0.75rem;
                    color: #888;
                }
                .autocomplete-price {
                    font-size: 0.85rem;
                    color: var(--accent-primary, #FFD700);
                    font-weight: 600;
                    margin-left: 10px;
                }
                .autocomplete-footer {
                    padding: 0;
                }
                .view-all-results {
                    width: 100%;
                    background: none;
                    border: none;
                    color: #888;
                    padding: 10px;
                    cursor: pointer;
                    font-size: 0.8rem;
                }
                .view-all-results:hover {
                    color: white;
                    background: rgba(255,255,255,0.05);
                }
            `;
            document.head.appendChild(style);
        }

        container.style.display = 'block';
    }
});
